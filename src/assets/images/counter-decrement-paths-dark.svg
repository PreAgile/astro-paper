<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 800" font-family="Virgil, 'Cascadia Code', monospace">
  <!-- Title -->
  <text x="450" y="35" font-size="22" font-weight="bold" text-anchor="middle" fill="#e2e8f0">
    Counter Decrement Paths (3 Paths ‚Üí Problem!)
  </text>

  <!-- Increment (Start) -->
  <g>
    <rect x="325" y="70" width="250" height="70" fill="#14532d" stroke="#4ade80" stroke-width="3" rx="12"/>
    <text x="450" y="100" font-size="16" font-weight="bold" text-anchor="middle" fill="#86efac">getCamoufoxPage()</text>
    <text x="450" y="125" font-size="14" text-anchor="middle" fill="#86efac">counter++ (Line 3745)</text>
  </g>

  <!-- Arrow down -->
  <line x1="450" y1="140" x2="450" y2="180" stroke="#94a3b8" stroke-width="3" marker-end="url(#arrow)"/>

  <!-- Trigger Events Box -->
  <g>
    <rect x="300" y="180" width="300" height="60" fill="#334155" stroke="#64748b" stroke-width="2" rx="8"/>
    <text x="450" y="210" font-size="15" font-weight="bold" text-anchor="middle" fill="#e2e8f0">3 Different Triggers</text>
    <text x="450" y="230" font-size="12" text-anchor="middle" fill="#94a3b8">(Normal, Exception, Disconnect)</text>
  </g>

  <!-- Three paths split -->
  <line x1="450" y1="240" x2="450" y2="270" stroke="#94a3b8" stroke-width="3"/>
  <line x1="450" y1="270" x2="150" y2="310" stroke="#94a3b8" stroke-width="3" marker-end="url(#arrow)"/>
  <line x1="450" y1="270" x2="450" y2="310" stroke="#94a3b8" stroke-width="3" marker-end="url(#arrow)"/>
  <line x1="450" y1="270" x2="750" y2="310" stroke="#94a3b8" stroke-width="3" marker-end="url(#arrow)"/>

  <!-- Path 1: closeSession -->
  <g>
    <rect x="25" y="310" width="250" height="130" fill="#1e3a5f" stroke="#60a5fa" stroke-width="3" rx="12"/>
    <text x="150" y="340" font-size="15" font-weight="bold" text-anchor="middle" fill="#93c5fd">Path 1: closeSession()</text>
    <text x="45" y="365" font-size="12" fill="#cbd5e1">Trigger: Normal close</text>
    <text x="45" y="390" font-size="12" fill="#cbd5e1">Location: Line 1142</text>
    <text x="45" y="415" font-size="13" font-weight="bold" fill="#f87171">Action: counter--</text>
  </g>

  <!-- Path 2: safeCloseSession -->
  <g>
    <rect x="325" y="310" width="250" height="130" fill="#78350f" stroke="#fbbf24" stroke-width="3" rx="12"/>
    <text x="450" y="340" font-size="15" font-weight="bold" text-anchor="middle" fill="#fcd34d">Path 2: safeCloseSession()</text>
    <text x="345" y="365" font-size="12" fill="#cbd5e1">Trigger: Exception/Timeout</text>
    <text x="345" y="390" font-size="12" fill="#cbd5e1">Location: Line 975</text>
    <text x="345" y="415" font-size="13" font-weight="bold" fill="#f87171">Action: counter--</text>
  </g>

  <!-- Path 3: disconnect handler -->
  <g>
    <rect x="625" y="310" width="250" height="130" fill="#450a0a" stroke="#f87171" stroke-width="3" rx="12"/>
    <text x="750" y="340" font-size="15" font-weight="bold" text-anchor="middle" fill="#fca5a5">Path 3: disconnect handler</text>
    <text x="645" y="365" font-size="12" fill="#cbd5e1">Trigger: Browser crash</text>
    <text x="645" y="390" font-size="12" fill="#cbd5e1">Location: Line 3928</text>
    <text x="645" y="415" font-size="13" font-weight="bold" fill="#f87171">Calls: safeCloseSession()</text>
  </g>

  <!-- Converge arrows -->
  <line x1="150" y1="440" x2="450" y2="490" stroke="#94a3b8" stroke-width="3" marker-end="url(#arrow)"/>
  <line x1="450" y1="440" x2="450" y2="490" stroke="#94a3b8" stroke-width="3" marker-end="url(#arrow)"/>
  <line x1="750" y1="440" x2="450" y2="490" stroke="#94a3b8" stroke-width="3" marker-end="url(#arrow)"/>

  <!-- Problem Box -->
  <g>
    <rect x="200" y="490" width="500" height="100" fill="#450a0a" stroke="#f87171" stroke-width="4" rx="12"/>
    <text x="450" y="520" font-size="17" font-weight="bold" text-anchor="middle" fill="#f87171">‚ö†Ô∏è PROBLEM: Race Condition</text>
    <text x="450" y="545" font-size="13" text-anchor="middle" fill="#fca5a5">When watchdog timeout occurs:</text>
    <text x="450" y="565" font-size="13" text-anchor="middle" fill="#fca5a5">Path 2 (safeClose) AND Path 1 (finally) both execute!</text>
    <text x="450" y="585" font-size="13" font-weight="bold" text-anchor="middle" fill="#f87171">‚Üí counter-- happens TWICE! üí•</text>
  </g>

  <!-- Solution Box -->
  <g>
    <rect x="150" y="620" width="600" height="150" fill="#14532d" stroke="#4ade80" stroke-width="3" rx="12"/>
    <text x="450" y="650" font-size="18" font-weight="bold" text-anchor="middle" fill="#86efac">‚úì Solution: Idempotent Flag</text>

    <rect x="180" y="665" width="540" height="95" fill="#064e3b" stroke="#4ade80" stroke-width="2" rx="8" fill-opacity="0.5"/>
    <text x="200" y="690" font-size="12" font-family="'Cascadia Code', monospace" fill="#86efac">session.counterDecremented?: boolean</text>
    <text x="200" y="710" font-size="12" font-family="'Cascadia Code', monospace" fill="#86efac">if (session.counterDecremented) return;</text>
    <text x="200" y="730" font-size="12" font-family="'Cascadia Code', monospace" fill="#86efac">session.counterDecremented = true;</text>
    <text x="200" y="750" font-size="12" font-family="'Cascadia Code', monospace" fill="#86efac">counter--;</text>
  </g>

  <!-- Arrow marker definition -->
  <defs>
    <marker id="arrow" markerWidth="10" markerHeight="10" refX="5" refY="5" orient="auto">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#94a3b8"/>
    </marker>
  </defs>
</svg>
