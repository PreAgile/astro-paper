<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 800" font-family="Virgil, 'Cascadia Code', monospace">
  <!-- Title -->
  <text x="500" y="35" font-size="24" font-weight="bold" text-anchor="middle" fill="#1e293b">
    Orphan Lock Lifecycle: From Normal to Orphaned
  </text>

  <!-- Normal Flow (Left Side) -->
  <g>
    <text x="250" y="80" font-size="18" font-weight="bold" text-anchor="middle" fill="#22c55e">
      âœ… Normal Flow
    </text>

    <!-- Step 1: attach() -->
    <rect x="100" y="110" width="300" height="80" fill="#dcfce7" stroke="#22c55e" stroke-width="3" rx="10"/>
    <text x="250" y="135" font-size="14" font-weight="bold" text-anchor="middle" fill="#15803d">1. attach()</text>
    <text x="120" y="160" font-size="12" fill="#166534">Lock ìƒì„±</text>
    <text x="120" y="180" font-size="12" fill="#166534">activeCount: 0 â†’ 1</text>

    <!-- Arrow -->
    <path d="M 250 190 L 250 230" stroke="#22c55e" stroke-width="3" marker-end="url(#arrow-green)"/>

    <!-- Step 2: Work -->
    <rect x="100" y="230" width="300" height="80" fill="#dcfce7" stroke="#22c55e" stroke-width="3" rx="10"/>
    <text x="250" y="255" font-size="14" font-weight="bold" text-anchor="middle" fill="#15803d">2. ì‘ì—… ìˆ˜í–‰</text>
    <text x="120" y="280" font-size="12" fill="#166534">ë¸Œë¼ìš°ì € ì‚¬ìš© ì¤‘...</text>
    <text x="120" y="300" font-size="12" fill="#166534">activeCount: 1 (ìœ ì§€)</text>

    <!-- Arrow -->
    <path d="M 250 310 L 250 350" stroke="#22c55e" stroke-width="3" marker-end="url(#arrow-green)"/>

    <!-- Step 3: release() -->
    <rect x="100" y="350" width="300" height="80" fill="#dcfce7" stroke="#22c55e" stroke-width="3" rx="10"/>
    <text x="250" y="375" font-size="14" font-weight="bold" text-anchor="middle" fill="#15803d">3. release()</text>
    <text x="120" y="400" font-size="12" fill="#166534">Lock í•´ì œ</text>
    <text x="120" y="420" font-size="12" fill="#166534">activeCount: 1 â†’ 0</text>

    <!-- Arrow -->
    <path d="M 250 430 L 250 470" stroke="#22c55e" stroke-width="3" marker-end="url(#arrow-green)"/>

    <!-- Step 4: cleanup -->
    <rect x="100" y="470" width="300" height="80" fill="#dcfce7" stroke="#22c55e" stroke-width="3" rx="10"/>
    <text x="250" y="495" font-size="14" font-weight="bold" text-anchor="middle" fill="#15803d">4. cleanup</text>
    <text x="120" y="520" font-size="12" fill="#166534">activeCount === 0</text>
    <text x="120" y="540" font-size="12" fill="#166534">locks.delete(sessionId) âœ…</text>
  </g>

  <!-- Problem Flow (Right Side) -->
  <g>
    <text x="750" y="80" font-size="18" font-weight="bold" text-anchor="middle" fill="#dc2626">
      âŒ Orphan Flow
    </text>

    <!-- Step 1: attach() -->
    <rect x="600" y="110" width="300" height="80" fill="#fef2f2" stroke="#dc2626" stroke-width="3" rx="10"/>
    <text x="750" y="135" font-size="14" font-weight="bold" text-anchor="middle" fill="#991b1b">1. attach()</text>
    <text x="620" y="160" font-size="12" fill="#7f1d1d">Lock ìƒì„±</text>
    <text x="620" y="180" font-size="12" fill="#7f1d1d">activeCount: 0 â†’ 1</text>

    <!-- Arrow -->
    <path d="M 750 190 L 750 230" stroke="#dc2626" stroke-width="3" marker-end="url(#arrow-red)"/>

    <!-- Step 2: Exception -->
    <rect x="600" y="230" width="300" height="80" fill="#fef2f2" stroke="#dc2626" stroke-width="3" rx="10"/>
    <text x="750" y="255" font-size="14" font-weight="bold" text-anchor="middle" fill="#991b1b">2. Exception! ğŸ’¥</text>
    <text x="620" y="280" font-size="12" fill="#7f1d1d">ì‘ì—… ì¤‘ ì—ëŸ¬ ë°œìƒ</text>
    <text x="620" y="300" font-size="12" fill="#7f1d1d">activeCount: 1 (ê·¸ëŒ€ë¡œ)</text>

    <!-- Arrow -->
    <path d="M 750 310 L 750 350" stroke="#dc2626" stroke-width="3" marker-end="url(#arrow-red)" stroke-dasharray="5,5"/>

    <!-- Step 3: release() NOT called -->
    <rect x="600" y="350" width="300" height="80" fill="#fef2f2" stroke="#dc2626" stroke-width="3" rx="10" stroke-dasharray="10,5"/>
    <text x="750" y="375" font-size="14" font-weight="bold" text-anchor="middle" fill="#991b1b">3. release() âŒ</text>
    <text x="620" y="400" font-size="12" fill="#7f1d1d" font-style="italic">í˜¸ì¶œë˜ì§€ ì•ŠìŒ!</text>
    <text x="620" y="420" font-size="12" fill="#7f1d1d">activeCount: 1 (ì—¬ì „íˆ)</text>

    <!-- Arrow -->
    <path d="M 750 430 L 750 470" stroke="#dc2626" stroke-width="3" marker-end="url(#arrow-red)" stroke-dasharray="5,5"/>

    <!-- Step 4: NOT cleaned -->
    <rect x="600" y="470" width="300" height="80" fill="#fef2f2" stroke="#dc2626" stroke-width="3" rx="10" stroke-dasharray="10,5"/>
    <text x="750" y="495" font-size="14" font-weight="bold" text-anchor="middle" fill="#991b1b">4. cleanup âŒ</text>
    <text x="620" y="520" font-size="12" fill="#7f1d1d">activeCount !== 0</text>
    <text x="620" y="540" font-size="12" font-weight="bold" fill="#dc2626">Lockì´ ë©”ëª¨ë¦¬ì— ë‚¨ìŒ (Orphan!)</text>
  </g>

  <!-- Reference Chain Diagram -->
  <g>
    <rect x="100" y="600" width="800" height="180" fill="#fef3c7" stroke="#f59e0b" stroke-width="3" rx="10"/>
    <text x="500" y="630" font-size="16" font-weight="bold" text-anchor="middle" fill="#92400e">
      ğŸ”— Orphan Lockì˜ ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë©”ì»¤ë‹ˆì¦˜
    </text>

    <text x="120" y="665" font-size="14" fill="#78350f">Lock ê°ì²´ (100 bytes)</text>
    <path d="M 300 660 L 360 660" stroke="#f59e0b" stroke-width="2" marker-end="url(#arrow-orange)"/>

    <text x="370" y="665" font-size="14" fill="#78350f">state.closeSession (í•¨ìˆ˜ í´ë¡œì €)</text>
    <path d="M 630 660 L 690 660" stroke="#f59e0b" stroke-width="2" marker-end="url(#arrow-orange)"/>

    <text x="700" y="665" font-size="14" fill="#78350f">BrowserContext</text>

    <text x="180" y="705" font-size="14" fill="#78350f">â†“</text>
    <text x="180" y="725" font-size="13" fill="#78350f">Page ê°ì²´ë“¤</text>

    <text x="440" y="705" font-size="14" fill="#78350f">â†“</text>
    <text x="440" y="725" font-size="13" fill="#78350f">ë¸Œë¼ìš°ì € í”„ë¡œì„¸ìŠ¤</text>

    <text x="700" y="705" font-size="14" fill="#78350f">â†“</text>
    <text x="650" y="725" font-size="13" font-weight="bold" fill="#dc2626">ìˆ˜ë°± MB ë©”ëª¨ë¦¬!</text>

    <text x="120" y="760" font-size="13" font-weight="bold" fill="#991b1b">
      ê²°ê³¼: Lockì´ ì •ë¦¬ë˜ì§€ ì•Šìœ¼ë©´ â†’ ì „ì²´ ì°¸ì¡° ì²´ì¸ì´ GC ë¶ˆê°€ â†’ ë©”ëª¨ë¦¬ ëˆ„ìˆ˜
    </text>
  </g>

  <!-- Markers for arrows -->
  <defs>
    <marker id="arrow-green" markerWidth="10" markerHeight="10" refX="5" refY="5" orient="auto">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#22c55e"/>
    </marker>
    <marker id="arrow-red" markerWidth="10" markerHeight="10" refX="5" refY="5" orient="auto">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#dc2626"/>
    </marker>
    <marker id="arrow-orange" markerWidth="10" markerHeight="10" refX="5" refY="5" orient="auto">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#f59e0b"/>
    </marker>
  </defs>
</svg>
